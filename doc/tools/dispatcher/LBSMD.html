<!--#set var="TITLE" value="Load-Balancing Service Mapping Daemon (LBSMD)" -->
<!--#set var="DOCROOT" value="../.." -->
<!--#include virtual="../../ssi/header.shtml" -->

<h1>Load-Balancing Service Mapping Daemon (<span class="ncbi_app">LBSMD</span>)</h1>

<font size=1><span class="ncbi_note">Note</span>: Due to security issues, not all links in the public version
of this file could be accessible by outside NCBI users. Unrestricted version of this document is available to
inside NCBI users at:
<a href="http://intranet.ncbi.nlm.nih.gov/ieb/ToolBox/CPP_DOC/tools/dispatcher/LBSMD.html" class="ncbi_url">>http://intranet.ncbi.nlm.nih.gov/ieb/ToolBox/CPP_DOC/tools/dispatcher/LBSMD.html</a>.
</font>

<h2>Contents</h2>

<ol>
<ul>
    <li> <a href="#ref_Overview">Overview</a>
    <li> <a href="#ref_Details"><span class="ncbi_app">LBSMD</span> in Details</a>
    <li> <a href="#ref_Example">Example of Configuration File</a>
    <li> <a href="#ref_Client">Load-Balancing Service Mapping Client (<span class="ncbi_app">LBSMC</span>)</a>
    <li> <a href="#ref_Penalizer">Server Penalizer</a>
</ul>
</ol>

<p><hr><p>


<a name="ref_Overview"></a><h2>Overview</h2>

In general, <span class="ncbi_app">LBSMD</span> should be run at NCBI site on every host that carries either public
or private servers implementing NCBI service(s) (see however discussion about
<a href="#ref_Static"><span class="ncbi_term">static</span></a> servers). The services include CGI programs or standalone servers
to access NCBI data. Each service has a name assigned to it, <span class="ncbi_interface">TaxServer</span>
for instance. The name uniquely identifies the service, and - <em>most importantly</em> -
the protocol used for data exchange, i.e. any client connecting to service <span class="ncbi_interface">TaxServer</span>
knows how to communicate with that service, whereas the service can be
implemented in various ways on hosts across NCBI.
That is, the service could be implemented as a standalone server on
a host <span class="ncbi_value">X</span>, and as a CGI program on the same or another host <span class="ncbi_value">Y</span>.
(Note however, that on a certain host there should <em>not</em> be more than one
server of the same <a href="#ref_ServerType">type</a> for the same service.)
Moreover, the same server can implement several services, that is
services with different names. For example, one service (like
<span class="ncbi_interface">Entrez2</span>) can accept binary data only, and another one
(say <span class="ncbi_interface">Entrez2Text</span>) can accept data only in text format.
For the server, the distinction between those two could be in this case
made by using a <a href="#ref_ContentType">content type specifier</a>.

<p>
The goal of <span class="ncbi_app">LBSMD</span> is to maintain a table of all services
available at NCBI at the moment. In addition, <span class="ncbi_app">LBSMD</span> keeps track of
servers, which are found non-functional (dead servers), and
it is also responsible for propagating trouble reports,
obtained back from the applications about their experience with
advertized servers (e.g. an advertized server is not
technically dead, but generates sort of garbage when accessed).
Further in this document the latter kind of feedback is called a
<span class="ncbi_term">penalty</span>.

<p>
The principle of load-balancing is simple: each server implementing
a service is assigned a (calculated) rate. The higher the rate
the better the chance for that the server to be chosen. Note that load-balancing
is thus almost never deterministic (see however, discussion of negative
<a href="#ref_Bonus">local bonus coefficient</a>).

<p>
It is not obvious that the load-balancing daemon does not calculate the rates of servers.
Instead, its primary goal is to collect all necessary information for that. The server
calculates two parameters, normal host status and so called BLAST host status (based on the
instant load of the system). These parameters are then used to calculate the
rate of all (non-<a href="#ref_Static"><span class="ncbi_term">static</span></a>) servers on that host as
shown in <a href="../../lxr/source/src/connect/ncbi_lbsm.c"><span class="ncbi_file">connect/ncbi_lbsm.c</span></a>
(which is a part of <a href="../../libs/conn.html#ref_ServiceAPI">service mapping API</a>, not <span class="ncbi_app">LBSMD</span>).

<p><hr><p>


<a name="ref_Details"></a><h2><span class="ncbi_app">LBSMD</span> in Details</h2>

<span class="ncbi_app">LBSMD</span> is configured by means of a configuration file (default name <span class="ncbi_file">servrc.cfg</span>),
which is also shared with <a href="DISPD.html#ref_NCBID">NCBI CGI engine</a>, <span class="ncbi_cgi">NCBID.CGI</span>.
Each line in the file either defines a service, or is a part of the host environment,
or is an include directive, or, finally, is an empty line (the one entirely blank or containing
a comment only). Empty lines are all ignored in the file.
Any single configuration line can be split into several physical lines by
inserting backslash symbols (\) before the line breaks.
A comment is introduced by the hash symbol (#).

<p>
<a name="ref_HostEnvironment"></a>A configuration line of the form
<pre class="ncbi_code">name=value</pre>

places itself in the host environment. The host environment can be accessed by
clients when they make the service name resolution. Initially, the host environment
was designed to help the client know about limitations/options, which the host has,
and based on this additional information the client can make a decision whether the server
(despite that it is implementing the service) is suitable for carrying out client's request.
For example, the host environment can give the client an idea about what are the databases
available on the host. The host environment is not interpreted or used in any way both by the daemon and
by the load-balancing algorithm, except for that <span class="ncbi_var">name</span> must be a valid identifier.
The <span class="ncbi_value">value</span> may be practically anything, even empty.
It is left solely to the client to parse the environment and to look for the information in interest.
The host environment can be obtained from the service iterator via call to
<a href="../../lxr/ident?i=SERV_GetNextInfoEx"><span class="ncbi_func">SERV_GetNextInfoEx()</span></a>,
which is documented in <a href="../../libs/conn.html#ref_ServiceAPI">service mapping API</a>.<br>
<span class="ncbi_note">Note</span>: White characters surrounding <span class="ncbi_var">name</span> are not preserved, but they are
preserved in <span class="ncbi_value">value</span>, i.e. when appear after the assignment sign.

<p>
<a name="ref_Include"></a>A configuration line of the form
<pre class="ncbi_code">%include filename</pre>
causes the named file <span class="ncbi_var">filename</span> to be read at this point of the surrounding configuration
file. The daemon always assumes that relative file names (those which names do not start with
the slash character (/)) are looked for with the daemon startup directory as a base.
This is true for any level of nesting.

<p>
Once started the daemon first assignes the top configuration file as <span class="ncbi_file">/var/etc/lbsm/servrc.cfg</span>,
then tries to read it. If the file is not found (or is not readable), the daemon looks for the configuration
file <span class="ncbi_file">servrc.cfg</span> in the directory, from which it has been started. If found, that file is assigned
as the top configuration file. This fallback machanism is not used when the configuration
file name is explicitly stated in the command line. When running, the daemon periodically
checks the top configuration file and all its descendants and reloads (discards) their contents
if some of the files have been either updated, (re-)moved, or added.

<p>
<a name="ref_Service"></a>A <span class="ncbi_var">service</span> is defined by a line of the form
<pre class="ncbi_code">service_name [check_time] server_descriptor [| launcher_info ]</pre>
<ul>
<li><span class="ncbi_var">service_name</span> names the service, for instance
<span class="ncbi_interface">TaxServer</span>.
<li><span class="ncbi_var">[check_time]</span> is an optional parameter (if omitted,
the surrounding square brackets must go, too),
which specifies the number of seconds for periodic checkups.
For example, <span class="ncbi_value">[120]</span> means to check the server once
every 2 minutes. Note the square brackets - they are required. Checkups can only be done for
servers running locally, that is specifying a check timeout for any server located outside
the local machine causes a warning printed and the timeout ignored.
<li><span class="ncbi_var">server_descriptor</span> specifies address of the server and
supplies additional information, which is described in details later in this document.
An example of the <span class="ncbi_var">server_descriptor</span>:
<pre class="ncbi_code">STANDALONE somehost:1234 R=3000 L=yes S=yes B=-20</pre>
<li><span class="ncbi_var">launcher_info</span> is basically a command line
preceded by a pipe symbol ( | ), delimiting from <span class="ncbi_var">server_descriptor</span>.
It is only required for <a href="#ref_ServerType">servers of type</a> <span class="ncbi_app">NCBID</span>,
which are configured on the local host.
</ul>

<p>
<span class="ncbi_var">Server_descriptor</span>, also detailed in
<a href="../../lxr/source/include/connect/ncbi_server_info.h"><span class="ncbi_file">connect/ncbi_server_info.h</span></a>,
consists of the following fields
<ol>
<span class="ncbi_code">server_type [host][:port] [arguments] [flags]</span><br>
where:
<ul type=square>
<li><a name="ref_ServerType"></a><span class="ncbi_var">server_type</span> is one of the following keywords (see also
  <a href="../../libs/conn.html#ref_ServerTypes">here</a>):<br>
  <ul compact type=bullet>
  <li><span class="ncbi_app">NCBID</span> for servers launched by <a href="DISPD.html#ref_NCBID"><span class="ncbi_cgi">ncbid.cgi</span></a>;
  <li><span class="ncbi_type">STANDALONE</span> for standalone servers listening on dedicated ports;
  <li><span class="ncbi_type">HTTP_GET</span> for servers, which are the CGI programs accepting only <span class="ncbi_interface">GET</span> request method;
  <li><span class="ncbi_type">HTTP_POST</span> for servers, which are the CGI programs accepting only <span class="ncbi_interface">POST</span> request method;
  <li><span class="ncbi_type">HTTP_POST</span> for servers, which are the CGI programs accepting both of either <span class="ncbi_interface">GET</span> or <span class="ncbi_interface">POST</span> request methods;
  <li><span class="ncbi_type">DNS</span> for introduction of a name (fake service), which can be later used in
  load-balancing domain name resolution;<br>
  <li><span class="ncbi_type">NAMEHOLD</span> for declaration of service names that cannot be defined in any other configuration
  files except for the current configuration file.<br>
  <span class="ncbi_note">Note</span>: <span class="ncbi_type">FIREWALL</span> server specification may not be used in configuration file (i.e. may neither be declared as
  services nor as service name holders).
  </ul>
<li>Both <span class="ncbi_var">host</span> and <span class="ncbi_dir">port</span> parameters are optional. Defaults are local host
and port 80 except for <span class="ncbi_type">STANDALONE</span> and <span class="ncbi_type">DNS</span> servers, which <em>do not have</em> a default port value.</br>
<a name="ref_Static"></a>If <span class="ncbi_var">host</span> <em>is specified</em> (by either of the following:
keyword <span class="ncbi_keyword">localhost</span>, localhost IP address <span class="ncbi_url">127.0.0.1</span>, real host name or IP address)
then the described server is not a subject for variable load-balancing, but is a so-called
<span class="ncbi_term">static</span> server. Such a server always has a constant rate, independent of any host load.
<li><span class="ncbi_var">arguments</span> are required for HTTP* servers, and must specify
local part of URL of the CGI program and optionally parameters, like:
<ol>
<span class="ncbi_cmd">/somepath/somecgi.cgi?param1&amp;param2=value2&amp;param3=value3</span>
</ol>
If no parameters are to be supplied then the question mark (?) must be omitted, too.<br>
For <span class="ncbi_app">NCBID</span> servers, <span class="ncbi_var">arguments</span> are parameters to
pass to the server and are formed as arguments for CGI programs, i.e.
<ol>
<span class="ncbi_cmd">param1&amp;param2&amp;param3=value</span>
</ol>
As a special rule, '' (two single quotes) may be used to denote an empty argument for <span class="ncbi_app">NCBID</span> server.<br>
<span class="ncbi_type">STANDALONE</span> and <span class="ncbi_type">DNS</span> servers do <em>not</em> take any <span class="ncbi_var">arguments</span>.
<li><span class="ncbi_var">flags</span> can come in no specific order (but no more than one instance of a flag is allowed),
and essentially are the optional modifiers of values used by default. The following flags are
recognized:
<ul type=circle>
  <li>load calculation keyword:
  <ul type=bullet>
    <li><span class="ncbi_app_a">Blast</span> to use special algorithm for rate calculation acceptable for <a href="http://www.ncbi.nlm.nih.gov/BLAST">BLAST</a>
	applications. The algorithm uses instant values of the host load, and thus is less conservative and more
	reactive than the ordinary one;
    <li><span class="ncbi_app_a">Regular</span> to use an ordinary rate calculation (default, and the only load calculation
    option allowed for <a href="#ref_Static"><span class="ncbi_term">static</span></a> servers).
  </ul>
  <li>base rate:
  <ul type=bullet>
  <li><span class="ncbi_app_a">R=value</span> sets base server reachability rate (as a floating point number),
  default is 1000. Any negative value makes the server unreachable, and a value of&nbsp;0 uses the default.
  The maximal allowed base rate is 100000.
  </ul>
  <li><a name="ref_Local"></a>locality markers:
  <ul type=bullet>
     <li><span class="ncbi_app_a">L={yes|no}</span> sets (if <span class="ncbi_value">yes</span>) the server to be <span class="ncbi_term">local only</span>.
     Default is <span class="ncbi_value">no</span>.
     <a href="../../libs/conn.html#ref_ServiceAPI">Service mapping API</a> returns <span class="ncbi_term">local only</span> servers
     in the case of mapping with the use of <span class="ncbi_app">LBSMD</span> running on the same - local - host (direct mapping),
     or if the dispatching (indirect mapping) occurs within the NCBI Intranet. Otherwise, if service mapping
     occurs using non-local network (certainly indirectly, via exchange with <a href="DISPD.html"><span class="ncbi_cgi">dispd.cgi</span></a>)
     then <span class="ncbi_term">local only</span> servers are not seen.
  </ul>
  <ul type=bullet>
     <li><span class="ncbi_app_a">P={yes|no}</span> sets (if <span class="ncbi_value">yes</span>) the server to be <span class="ncbi_term">private</span>.
     Default is <span class="ncbi_value">no</span>.
     Private servers are not seen by the outside users (exactly like <a href="#ref_Local"><span class="ncbi_term">local</span></a> servers),
     but in addition these servers are not seen from the NCBI Intranet if requested from a host, which is different
     from one where the private server runs. This flag cannot be used for <span class="ncbi_type">DNS</span> servers.
  </ul>
  <span class="ncbi_note">Note</span>: If necessary, both <span class="ncbi_app_a">L</span> and <span class="ncbi_app_a">P</span> markers can be combined in a particular service definition.
  <li><a name="ref_Stateful"></a>stateful server:
  <ul type=bullet>
     <li><span class="ncbi_app_a">S={yes|no}</span> sets (if <span class="ncbi_value">yes</span>) that the server can only accept dedicated connections,
     and is not capable of doing <span class="ncbi_term">stateless</span> (HTTP-like) data exchange. Such a server can only be
     accessed by creating a stream connection to it, and the entire data transfer is to happen
     while the connection is alive. Default is <span class="ncbi_value">no</span>. This flag <em>cannot</em> be specified for HTTP* servers,
     and is silently ignored for <span class="ncbi_type">DNS</span> servers.<br>
     <span class="ncbi_note">Note</span>: Due to mutual incompatibility, Web-browsers <i>cannot</i> directly connect to <span class="ncbi_term">stateful</span> servers of
     any type.
  </ul>
  <li><a name="ref_ContentType"></a>content type specifier:
  <ul type=bullet>
     <li><span class="ncbi_app_a">C=type/subtype</span> specifies what is the data type that the server expects.
     This content type is to be used by a client, which wants to connect to the
     server. There is no default value for this flag, and the flag cannot be used for <span class="ncbi_type">DNS</span>servers.
  </ul>
  <li><a name="ref_Bonus"></a>local bonus coefficient:
  <ul type=bullet>
     <li><span class="ncbi_app_a">B=value</span>. The interpretation of this flag depends on the sign of <span class="ncbi_value">value</span>. When positive,
     <span class="ncbi_value">value</span> specifies a multiplier, which applies to the server rate when the server is locally run.
     When zero (default), the slight default rate increase takes effect for locally run servers. When <span class="ncbi_value">value</span> is negative, the
     locally run server overrides those even having higher rates and preceding the local one, but only if the local server has
     a rate, which is not in the percentile (expressed by the absolute <span class="ncbi_value">value</span>) of average remaining rate of all other servers,
     implementing the service.<br>
     For example, a server on a <span class="ncbi_term">local</span> host <span class="ncbi_dir">Z</span> configured with <span class="ncbi_app_a">B=-5</span> (and currently having rate of 100)
     will be chosen by the <span class="ncbi_term">local</span> load-balancer even if there were servers on hosts <span class="ncbi_dir">X</span> and <span class="ncbi_dir">Y</span> having rates
     1000 and 2000, respectively, because 100 is more than 5% of (1000 + 2000)/2 = 1500, which is 75.</br>
     <span class="ncbi_note">Note</span> again that for this coefficient to play, <em>both</em> server and mapping must be on the same host.
  </ul>
  <li><a name="ref_Backup"></a>backup quorum:
  <ul type=bullet>
     <li><span class="ncbi_app_a">Q={value|yes|no}</span>. Server specifications having this flag set define
     so-called backup configuration, and must have host distinct from the local host. Also, this flag cannot apply
     to <span class="ncbi_type">NAMEHOLD</span> specifications. In a simple case <span class="ncbi_app_a">Q=yes</span> defines a backup entry, which gets activated
     when number of dynamic entries (which came from other hosts) for particular service becomes less than the number
     of the service's backup lines defined in the entire configuration (i.e. counting all files). The order in which
     backup entries are then chosen is defined by their order of appearance in configuration. In a more complex case,
     <span class="ncbi_app_a">Q=value</span> can be provided with the value corresponding to the minimal requirement on the number of
     active dynamic entries, regardless of the number of backup entries in configuraiton. When this quorum is
     met, no backup entries are being activated (or will be deactivated and put back pending).<br>
     <span class="ncbi_note">Note</span>: If several configuration lines for a partical service have <span class="ncbi_app_a">Q=value</span> flag then the quorum is the
     minimal value among specified. <span class="ncbi_app_a">Q=no</span> or <span class="ncbi_app_a">Q=0</span> defines an active service entry (as if <span class="ncbi_app_a">Q</span> flag
     were not specified at all).
  </ul>
</ul>
</ul>
<p>
  Server descriptors of type <span class="ncbi_type">NAMEHOLD</span> are special. As <span class="ncbi_var">arguments</span> they have only server type keyword.
  Namehold specification tells to the daemon that service of this name and type is not to be defined later
  in any configuration file except for the current. Also, if host is specified then this protection only works
  for the service name on the particular host. Port number is ignored (if specified).<br>
  <span class="ncbi_note">Note</span>: it is recommended to always put a dummy port number (like :0) in namehold specifications to avoid
  ambiguities with treating server type as a host name.<br>
  The followin example disables <span class="ncbi_var">TestService</span> of type <span class="ncbi_type">DNS</span> to be defined in all other configuration
  files included later, and <span class="ncbi_var">TestService2</span> to be defined as a <span class="ncbi_app">NCBID</span> service on host <span class="ncbi_dir">foo</span>:
<pre class="ncbi_code">
TestService  NAMEHOLD    :0 DNS
TestService2 NAMEHOLD foo:0 NCBID</pre>
</ol>


The main loop of the daemon comprises periodic checks of configuration file and reloads of the configuration if
necessary, checks and processings of incoming messages from load-balancing daemons running on
other hosts, generation and brodacast of the messages to other hosts about the load of the system and
configured services. Also, the daemon periodically checks whether the configured servers are alive, trying
to connect to them, and then to immediately disconnect, without sending/receiving any data. This way the daemon
is only able to check if the network port is working. Further server accessibility information could
be sent back to the daemon in the form of a <a href="#ref_Penalizer">penalty</a> from applications
that actually use the server.

<p>
The daemon can be configured by a dozen of switches, which modify certain
parameters from their default values. To see all command-line switches, switch <span class="ncbi_app_a">-h</span> may be used,
or NCBI Intranet users <em>only</em> can click <a href="http://ray.nlm.nih.gov/Service/lbsmd.cgi">here</a>.
Also, daemon reacts on <span class="ncbi_var">HUP</span> signal to reload its configuration,
and both <span class="ncbi_var">INT</span> and <span class="ncbi_var">TERM</span> signals to gracefully quit. Despite very high stability, usually
the daemon is forcedly started from <span class="ncbi_util">crontab</span> each every few minutes on all production hosts to ensure
that the daemon is always running. This technique is safe, because no more than one instance of the daemon
is permitted on a certain host, and any attempt to start more than one is rejected.

<p>
<span class="ncbi_app">LBSMD</span> can generate output to the logfile, which can be limited in size to prevent
disk from flooding with messages. NCBI Intranet users <em>only</em>
<a href="http://ray.nlm.nih.gov/Service/lbsmd.cgi?log">can take a look</a>
at (no more than 100) recent lines of the logfile on host <span class="ncbi_dir">ray</span>.
Signal <span class="ncbi_var">USR1</span> can be used to toggle verbosity level between less verbose (default) and
more verbose (when every warning generated is stored) modes.

<p>
Logfile size can be controlled by <span class="ncbi_app_a">-s</span> switch. By default <span class="ncbi_app_a">-s&nbsp;0</span> is the
active flag, which means to create (if necessary) and to append messages to the logfile with
no limitation on the file size whatsoever. <span class="ncbi_app_a">-s&nbsp;-1</span> instructs indefinite appending
to the logfile, which has however to exist. Otherwise, log messages are not stored.
<span class="ncbi_app_a">-s positive_number</span> restricts to create (if necessary) and to append to the logfile
until the file reaches the specified size in kilobytes. After that, the message logging is suspended,
and subsequent messages are discarded. Note that the limiting file size is only approximate,
and sometimes the logfile can grow slightly bigger. The daemon keeps track of logfiles and leaves
the final logging message either when switching from one file to another in case of the file has been
moved or removed or when the file size has reached its limit.

<p><hr><p>


<a name="ref_Example"></a><h2>Example of Configuration File</h2>

Below is an excerpt from sample configuration file, which declares some of the host environment,
advertizes one standalone stateful server, and one <span class="ncbi_app">NCBID</span> service, both implementing the same
service, and one local HTTP service.

<pre class="ncbi_code">
#
#    This is a configuration file of new NCBI service dispatcher
#

# This goes to host environment (rather practical)
db_list=a.db b.db c.db
# And this does too (rather illustrative)
my_entry="some very important value as a quoted string"

# Standalone server listening on port 9999
TestService STANDALONE :9999 S=yes R=2000

# NCBID server (Note empty quotes to prevent treating of Regular as
# an argument. Also note bar (|) followed by path and parameters of
# the executable.)
TestService NCBID '' Regular |
   /home/webuser/TestService/a.out "parameter 1"

# Local HTTP service w/o checks (note [0])
LocalService [0] HTTP /LocalService.cgi?param=somevalue L=yes

# Static server - check it each 200 seconds
StaticService [200] STANDALONE localhost:8888

# Static server from another host where LBSMD may even not be running
# (no checks at all or just [0] allowed for non-local static servers)
ForeignService [0] STANDALONE foreignhost:7777 R=300

# Backup entry for DNS service test_lb - will be activated if no dynamic
# entry would be found in the table of services
test_lb DNS otherhost Q=yes

# Hold service name PrivateService of type HTTP from being defined in
# included configuration files
PrivateService NAMEHOLD :0 HTTP

# Include another configuration file (Note that PrivateService of type HTTP
# will be rejected in that file and all its descendants)
%include /home/someuser/servrc.cfg.someuser

# Define PrivateService here as a real service
PrivateService HTTP /cgi-bin/privsrv.cgi?arg=val R=2000.0

# end of configuration
</pre>

NCBI Intranet users <em>only</em> can take a look at a real configuration file on the host <span class="ncbi_dir">ray</span>
by clicking <a href="http://ray.nlm.nih.gov/Service/lbsmd.cgi?cfg">here</a>.

<p><hr><p>


<a name="ref_Client"></a><h2>Load-Balancing Service Mapping Client (<span class="ncbi_app">LBSMC</span>)</h2>

This is a special <a href="../../lxr/source/src/connect/daemons/lbsmc.c">program</a>, which repeatedly
dumps onto the screen a table representing current contents of shared memory segment, where the daemon
collects all information about hosts and services. The client's output can be controlled by a number
of switches, full list of which can be obtained via switch <span class="ncbi_app_a">-h</span> alone, or NCBI Intranet users can click
<a href="http://ray.nlm.nih.gov/Service/lbsmc.cgi?-h">here</a>. For example, to print only
the hosts currently running the daemon one can use the following command:
<pre class="ncbi_cmd">
>./lbsmc -s none 0
08/23/01 11:36:35 ================== sampson ===================================
Hostname/IPaddr Task/CPU LoadAv LoadBl   Status   StatBl n1 n2 n3 n4 n5 q1 q2 q3
iblastd            4/2     2.01   2.00   220.26     0.00  0  0  0  0  0 10 10  0
muncher        *  11/16    0.01   0.05 14414.42 15950.00  0  0  0  0  0 22 22  0
ray               29/6     2.71   3.14    75.39  2860.00  0  0  0  0  0  1  1  0
sampson           11/6     0.16   0.17  2173.91  5830.00  0  0  0  0  0  0  0  0
schroeder         60/8     0.45   0.00   285.72  8000.00  0  0  0  0  0  0  0  0
--------------------------------------------------------------------------------
* Hosts: 5/5, Svcs: 0/12/0      |      Heap: 8192, used: 1736/1776, free: 6416 *


08/23/01 11:36:35 LBSMD PID was detected as 9733
</pre>

For NCBI Intranet users <em>only</em> the following live lists are available for browsing:
<ul type=circle>
<li><a href="http://ray.nlm.nih.gov/Service/lbsmc.cgi?-s_none_-w">Currently running hosts</a>;
<li><a href="http://ray.nlm.nih.gov/Service/lbsmc.cgi?-h_none_-w">Currently configured services and servers</a>;
<li><a href="http://ray.nlm.nih.gov/Service/lbsmc.cgi?-h_none_-w_-d">Currently dead servers</a>.
</ul>

<p>Some explanation to the client's output. The output usually contains 2 parts:
first comes the host table, followed by the service table. If <span class="ncbi_app_a">-f</span> switch
was specified, then the host table is prepended by raw heap printout, which shows
the data exactly in the order they appear in the shared memory. The output goes
in either long or short format depending on whether <span class="ncbi_app_a">-w</span> was specified
on the command line (the switch requests the long (wide) output). Wide output occupies
about 130 columns, while the short (normal) output takes 80 - the standard
terminal size. In cases when the service name is more than the allowed number
of characters to display, the trailing character will be shown as '>'.
When there is more information to display about host/service, a '+' characters
is set beside the host/service name (this additional information can be requested
by switch <span class="ncbi_app_a">-i</span>). When both '+' and '>' are to be shown,
they are replaced with '*'. In the wide output format, '#' shown in the
service line tells that there is no host information available for
the service (like for static servers). '!' character in the service
line denotes that the service was configured/stored with an error
(this character actually should never appear in the listings, and
should be reported whenever encountered). Wide output for hosts contain
the time of bootup and startup. If the startup time is preceded by a tilde '~',
then the host was gone for a while and then came back, while the client
was running. A plus char '+' in the times is to show that the date belongs
to the past year(s).

<p><hr><p>


<a name="ref_Penalizer"></a><h2>Server Penalizer</h2>

There is a means for application to report problems of accessing a certain server back to
the load-balancing daemon, in the form of the penalty, a value in the range <span class="ncbi_value">[0..100]</span>,
showing in percents how bad the server is. The value&nbsp;0 means the server is completely okay,
while&nbsp;100 means the server (is misbehaving and) should <em>not</em> be used at all. The penalty is
not a constant value: once set it starts to decrease in time first slowly, then faster and
faster until reaches zero. This way, if a server was penalized for some reason beyond its control
but afterwards the reason has gone, then the server becomes gradually available as its penalty
(not being reset by applications again in the absence of the offending reason) goes itself to zero.

<p>
Technically, the penalty is maintained by a daemon, which has the server configured.
That is, received by a certain host, which may be different from the one where the
server was put into configuration file, the penalty first migrates to that host,
and then the daemon on that host announces that the server was penalized.</br>
<span class="ncbi_note">Note</span>: Once the daemon is restarted, the penalty information is lost.

<p>
<a href="../../libs/conn.html#ref_ServiceAPI">Service mapping API</a> has a call
<a href="../../lxr/ident?i=SERV_Penalize"><span class="ncbi_func">SERV_Penalize()</span></a>
declared in <a href="../../lxr/source/include/connect/ncbi_service.h"><span class="ncbi_file">connect/ncbi_service.h</span></a>,
which can be used to set the penalty for the last server obtained from the mapping iterator.

<p>
For script files (like ones used to start/stop servers) there is a dedicated utility program called
<a href="../../lxr/source/src/connect/daemons/lbsm_penalize.c"><span class="ncbi_app">lbsm_penalize</span></a>,
which sets penalty from command line. Because of intervening the load-balancing
mechanism substantially this command should be used with extreme care.

<p>
<span class="ncbi_app">lbsm_penalize</span> is now a part of LBSM set of tools installed on all hosts that run <span class="ncbi_app">LBSMD</span>.
As explained above, penalizing means making a server less favorable for choosing by load-balancing
mechanism. Because of the fact that the full penalty of&nbsp;100% makes a server unavailable for clients at all,
at the time when the server is about to shut down (restart) it is wise to increase the server penalty
to the maximal value, thus excluding the server from the service mapping. (Otherwise, the load-balancing daemon
might not immediately notice that the server is down and continue dispatching to that server.)
Usually penalty takes at most 5 seconds to propagate to all participating network hosts.
That is, before an actual server shutdown the following sequence of commands can be used:
<pre class="ncbi_cmd">
&gt; ~ncbiduse/Service/lbsm_penalize 'Servicename STANDALONE 100 host 120'
&gt; sleep 5
&gt; <em>shutdown the server</em>
</pre>

The effect of the above is to set the maximal penalty&nbsp;<span class="ncbi_value">100</span> for the service <span class="ncbi_interface">Servicename</span> (of type
<span class="ncbi_type">STANDALONE</span>) running on host <span class="ncbi_var">host</span> for at least <span class="ncbi_value">120</span> seconds - note the last numeric value.
(After&nbsp;120 seconds the normal behavior of the penalty occurs, i.e. automatical decreasing in time if not reset again
to a different value with optional hold time.) Default hold time equals&nbsp;0.
In order for penalty to be realized by all hosts of the subnet, <span class="ncbi_cmd">sleep 5</span> precedes the server shutdown.
Please note single quotes surrounding penalty specification: they are required in a command shell because
<span class="ncbi_app">lbsm_penalize</span> takes only one argument, the entire penalty specification.

<p>
As soon as the server is down, <span class="ncbi_app">LBSMD</span> detects it in the matter of several seconds
(if not instructed otherwise via configuration file) and then never dispatches to the server until it is up.

In some circumstances the following command may come handy:
<pre class="ncbi_cmd">
&gt; ~ncbiduse/Service/lbsm_penalize 'Servicename STANDALONE 0 host'
</pre>
it resets the penalty to&nbsp;0 (no penalty) and is useful when, e.g. as for the previous example, the server is restarted
and ready in less than 120 seconds but the penalty is still held high by <span class="ncbi_app">LBSMD</span>.

<!--#include virtual="../../ssi/navlinks.shtml" -->

<table border=0 width="100%" cellspacing=0>
<tr>
<td align=left>
  <address><a href="mailto:cpp-core@ncbi.nlm.nih.gov">Anton Lavrentiev</a></address>
</td>
<!-- <td align=center><span class="ncbi_cvs_rev">$Revision$</span></td> -->
<td align=right><span class="ncbi_cvs_date">$Date$</span></td>
</tr>
</table>

<!--#include virtual="../../ssi/footer.shtml" -->
