(function(f){f.widget("ui.ncbilinkedselects",{_selectEls:[],_paramObj:{},_localMap:null,options:{firstPopulatedFromDs:true,localData:null,localDataCallback:null,selects:null,webservice:null},_create:function(){if(this.options.localData)this._localMap=eval(this.options.localData);this.options.firstPopulatedFromDs&&this._populateFirstSelect();this._selectEls=this.getSelects();this._setEvents()},_populateFirstSelect:function(){if(this.options.localData)for(var a=this._getFirstOptionsFromLocalDs(),b=
this._isArrayOfStrings(a),d=0;d<a.length;d++){var c=a[d];if(b)this.element.append('<option value="'+c+'">'+c+"</option>");else for(var e in c)this.element.append('<option value="'+c[e]+'">'+e+"</option>")}else this._getAndAppendFromWebService(this.element,{})},_getFirstOptionsFromLocalDs:function(){var a=[];if(this.options.localDataCallback)a=this.options.localDataCallback.apply(this,[this._localMap]);else for(var b=0;b<this._localMap.length;b++){var d=this._localMap[b];if(typeof d==="string")a.push(d);
else f.isPlainObject(d)&&a.push(d)}return a},getSelects:function(){if(this.options.selects)var a=f(this.options.selects);else{a=this.element.closest("fieldset, form");a.length===0&&f.ui.jig._isConsole("warn")&&console.warn("jig warning: ncbilinkedselects. Your select elements must be within either a fieldset or a form element");a=a.find("select");for(var b=false,d=[],c=0;c<a.length;c++){var e=a[c];if(e==this.element[0])b=true;b&&!f(e).hasClass("ui-ncbilinkedselects-ignore")&&d.push(e)}return f(d)}return this.element.add(a)},
_setEvents:function(){var a=this;this._selectEls.each(function(){var b=f(this),d=this.name;a._isLastSelect(d)||b.bind("change",function(c){a._resetNextSelects(d);a._populateNext(c)})})},_resetNextSelects:function(a){for(var b=false,d=0;d<this._selectEls.length;d++){var c=f(this._selectEls[d]);if(c.attr("name")==a)b=true;else b&&c.children("option").each(function(){var e=f(this);e.hasClass("ui-ncbilinkedselects-perm")||e.remove()})}},_getParamObj:function(a,b){if(this._isFirstSelect(a))this._paramObj=
{};this._paramObj[a]=b;return this._paramObj},_populateNext:function(a){var b=f(a.target),d=b.children("option:selected");if(!d.hasClass("ui-ncbilinkedselects-perm")){var c=b.attr("name"),e=b.val();a=this._getNextSelect(b.attr("name"));if(this.options.webservice){b=this._getParamObj(c,e);this._getAndAppendFromWebService(a,b)}else this.options.localData&&this._populateSelectFromLocalMap(b,d,a)}},_getAndAppendFromWebService:function(a,b){f.get(this.options.webservice,b,function(d,c,e){response=e.responseText;
a.append(response)},"HTML")},queryLocalService:function(a){function b(c){for(var e in c){var g=c[e];for(var h in g)if(g[h]===a){c=c[parseInt(e)+1];for(e=0;e<c.length;e++)f.isArray(c[e])||d.push(c[e]);return}jQuery.isArray(g)&&b(g)}}var d=[];b(this._localMap);return d},_populateSelectFromLocalMap:function(a,b,d){var c=this.options.localDataCallback;a=c?c.apply(this,[this._localMap,a,b,this._selectEls]):this.queryLocalService(a.val());b=this._isArrayOfStrings(a);for(c=0;c<a.length;c++){var e=a[c];if(b)d.append('<option value="'+
e+'">'+e+"</option>");else{var g,h;for(var i in e){g=i;h=e[i]}d.append('<option value="'+h+'">'+g+"</option>")}}},_isArrayOfStrings:function(a){return typeof a[0]==="string"},_isLastSelect:function(a){els=this._selectEls;return a===els[els.length-1].name?true:false},_isFirstSelect:function(a){els=this._selectEls;return a===els[0].name?true:false},_getNextSelect:function(a){for(var b=0;b<this._selectEls.length;b++)if(this._selectEls[b].name==a)return f(this._selectEls[b+1])}})})(jQuery);
