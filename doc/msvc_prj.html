<!--#set var="TITLE" value="MSVC++ Project File Conversion Tools" -->
<!--#set var="DOCROOT" value="." -->
<!--#include virtual="./ssi/header.shtml" -->
<i><h1><font color="#FF0000"><span style="background-color: #FFFFFF">Warning: This HTML page is deprecated</span></font></h1>

All new changes are being made to the Toolkit Book
at the following locations:
<ul>
<li>
<i>Official Release:</i> <a href="http://www.ncbi.nlm.nih.gov/books/bv.fcgi?call=bv.View..ShowTOC&rid=toolkit.TOC&depth=2">
    C++ Toolkit Book</a>.
</li>
<li>
<i>Development Version:</i> <a href="http://xpubmed0.ncbi.nlm.nih.gov:5701/books/bv.fcgi?call=bv.View..ShowTOC&rid=toolkit.TOC&depth=2">

    C++ Toolkit Book (no search engine, accessible from inside NCBI only)</a>. </li> </ul> The Development Version is the most recent documentation before it becomes an Official Release. While the Development Version is the lastest version, it is accessible only from inside NCBI, and the search engine functionality is currently missing. Also, the location of the Development Version may change without warning! So it is suggested that you use the Official Release, and use the Development Version only when necessary.</p> </i>

<hr>
<!--EOW-->

<h2>MSVC++ Project File Conversion Tools</h2>

This manual assumes that the UNIX-like environment is used to prepare
and manage MSVC++ project files, which in turn can be used to build NCBI
C++ Toolkit by MSVC++ Developer Studio. The following tools must be available in order for
the conversion scripts to work: <span class="ncbi_util">cat</span>, <span class="ncbi_util">cp</span>, <span class="ncbi_util">diff</span>, <span class="ncbi_util">echo</span>,
<span class="ncbi_util">egrep</span>, <span class="ncbi_util">expr</span>, <span class="ncbi_util">find</span>, <span class="ncbi_util">grep</span>,<span class="ncbi_util"> head</span>, <span class="ncbi_util">mv</span>,<span class="ncbi_util"> rm</span>,
<span class="ncbi_util">sh</span>, <span class="ncbi_util">tail</span>, <span class="ncbi_util">test</span>, <span class="ncbi_util">touch</span>, and <span class="ncbi_util">tr</span>. 
<br>
<hr WIDTH="100%">
<br>The idea behind the automatic project file conversion is that usually developer
works only with some fixed configuration (e.g. debug, single-threaded),
yet he/she must keep all other configurations in-sync.
Hereby we provide the developer with the means to work with (and make changes to)
a single configuration at any given moment of time. Then,
when the build process is about to occur, all other deficient configuration(s)
can be generated automatically from that fixed (template) configuration.
<p>
There are some limitations to the above scheme:
<ul>
<li>The per configuration dependencies are not supported, they are ignored and excluded from the resulting project file,
    with warning printed.</li>
<li>If libraries or object files are explicitly included in the project file list,
    they usually refer to fixed file placements (e.g. <span class="ncbi_file">src\connect\DebugMT\ncbi_socket.obj</span>),
    i.e. bound to the particular configuration it was built with. Therefore, you must <em>never</em> use the explicit
    inclusion of this kind when creating your single-configuration (template) project files.
    Instead, use workspace file (<span class="ncbi_file">.dsw</span>) <span class="ncbi_term">dependency mechanism</span>
    to link with such libraries and object files, and use linker options (<a href="config.html#ref_MsvcProjCXX">library list</a>)
    without explicit paths.</li>
</ul>

<p>
All the work of managing the project files is done by using of one or more of the
following shell <a name="scripts"></a>scripts:

<ul>
<li>
<a name="all2one_sh"></a><span class="ncbi_script">all2one.sh</span> - looks through the given project
file, prints out available configurations, and allows to extract any of
those. If there is only one configuration, the script does nothing. Special
care is taken to first check the project file consistency to avoid corrupting
the vital project file structure. Note, however, that the warning is printed if the
project file contains per configuration issues, which cannot be handled in a graceful
way, and thus ignored. Input file can be in either DOS or UNIX text file format
(respectively, with or without CR (carriage return) incorporated before LF (life feed) at
line ends). Output file is always in UNIX text file format, which is suitable for
CVS repository.</li>
<br>
<span class="ncbi_note">Note:</span> Aside the project file name, the second argument can be given to the script. This argument
is used as a name of configuration to extract without interactive inquiry. If the specified configuration
is not found, the script aborts with an error message.

<p><li>
<a name="one2all_sh"></a><span class="ncbi_script">one2all.sh</span> - takes a single-configuration
project file (perhaps the one created by <span class="ncbi_script">all2one.sh</span>
and derives multi-configuration project file containing 3 production configurations:
<span class="ncbi_config">Release</span>, <span class="ncbi_config">ReleaseMT</span>, and <span class="ncbi_config">ReleaseDLL</span>; and 3 debug configurations: <span class="ncbi_config">Debug</span>,
<span class="ncbi_config">DebugMT</span>, and <span class="ncbi_config">DebugDLL</span>. One option, <span class="ncbi_script_a">--without-dizzy</span>,
can precede the file name. If specified, then the C compiler, resource compiler and linker options,
which refer to additional paths, involving <span class="ncbi_dir">\\DIZZY\</span>, are removed.
Output file is always produced in DOS text file format (that is suitable
for immediate consumption by MSVC++), whereas input file can be in either UNIX or DOS format.</li>
<br>
<span class="ncbi_note">Note:</span> There is one additional argument, which is reserved for internal use only.
When given as <span class="ncbi_value">2</span>, only <span class="ncbi_config">DebugDLL</span> and <span class="ncbi_config">ReleaseDLL</span> configurations
are placed to the output file. When given as <span class="ncbi_value">4</span>, only the following four configurations
appear: <span class="ncbi_config">Debug</span>, <span class="ncbi_config">DebugMT</span>, <span class="ncbi_config">Release</span>, and <span class="ncbi_config">ReleaseMT</span>.

<p><li>
<a name="one2one_sh"></a><span class="ncbi_script">one2one.sh</span> - takes two arguments:
single-configuration project file name and one of standard configuration names
(<span class="ncbi_config">Debug</span>, <span class="ncbi_config">DebugMT</span>, <span class="ncbi_config">DebugDLL</span>, <span class="ncbi_config">Release</span>, <span class="ncbi_config">ReleaseMT</span>, <span class="ncbi_config">ReleaseDLL</span>) and replaces
the given project file with a new one, having the requested configuration. In case of non-standard configuration name,
an error results. Being an 'interface' script to both <span class="ncbi_script">all2one.sh</span> and
<span class="ncbi_script">one2all.sh</span>, this scipt can accept one option,
<span class="ncbi_script_a">--without-dizzy</span>, as described above.
Output file is created in UNIX text file format.</li>

<p><li>
<a name="include_sh"></a><span class="ncbi_script">include.sh</span> - takes an optional argument list, each
entry of which is a relative path to include file directory (default is the standard NCBI C++ Toolkit include
directory). The script then recursively looks through all project files, and tries to update compiler
switches with the given directory list. Directories, already specified in project files, are either replaced
(when the new directory resembles the old one), or added to the current list of include directories.
The main purpose of the script is to eliminate "global" configuration through "Tool/Options",
which is otherwise required to specify include file directories. Generated paths to include files are
always relative to the project file. The script is to be used from the <span class="ncbi_dir">msvc_prj</span>
directory each time, when the project file subtree is a kind rearranged and must be updated in the CVS.
Therefore, the project files are always produced in UNIX text file format.</li>

<p><li>
<a name="commit_sh"></a><span class="ncbi_script">commit.sh</span> -
control script for use from inside the CVS upon each commit to ensure
that the project being checked in contains one fixed configuration only (namely, <span class="ncbi_config">DebugDLL</span>).
This script as well checks that the file being committed is in UNIX text file format, and rejects if not.
The extensions (and only in directories specified in <span class="ncbi_script_a">DIRLIST</span>
parameter, as described below) checked are: <span class="ncbi_file">.dsw</span>,
<span class="ncbi_file">.dsp</span>, <span class="ncbi_">.bat</span>.</li>
No explicit call to this script is ever necessary: it is entirely internal to CVS and transparent for the user.

<br>
<em>Additional</em> functionality has been added to this script: if it detects that the file being committed
contains paths either to standard NCBI C Toolkit include files/libraries, or wxWindows include files/libraries,
then the paths are expanded to specify both relative (i.e. local) and absolute (i.e. via
<span class="ncbi_dir">\\DIZZY\public\ncbi</span>) locations, thus making possible to build
the project using either local or pre-built libraries. We require that if a toolkit is used locally (i.e. <em>not</em> via
<span class="ncbi_dir">\\DIZZY\public\ncbi</span>), then the upper-level directory of the toolkit has to be placed
at the same level as the NCBI C++ Toolkit top-level directory. We reserve that <span class="ncbi_dir">wxwin</span> and <span class="ncbi_dir">ncbi</span> subdirectories, when appear in the same parent directory as <span class="ncbi_dir">cxx</span>, contain wxWindows and NCBI C Toolkit correspondingly.
Click <a href="config.html#ref_MsvcProjWxwin">here</a> to know how to use the wxWindows package in these requirements.
One can later remove absolute references to <span class="ncbi_dir">\\DIZZY\</span> using option
<span class="ncbi_script_a">--without-dizzy</span> with either
<a href="#one2all_sh"><span class="ncbi_script">one2all.sh</span></a>, or
<a href="#one2one_sh"><span class="ncbi_script">one2one.sh</span></a>.

<br>
<a name="notes"></a><br><span class="ncbi_note">Please note</span> that the above tools are <em>not</em> project file <span class="ncbi_term">generation</span>
tools, but rather the project file <span class="ncbi_term">conversion</span> tools. That is, the resulting project file is correct if and only if the
source project file is. When a project file gets converted to a single-configuration template,
all the compiler switches and definitions, as well as other vital environment, have to be defined in a right way.</ul>

<p>
DOS batch file <a name="all_bat"></a><span class="ncbi_script">all.bat</span> can
generate all projects in a batch mode, provided that <span class="ncbi_util">msdev.exe</span>
is in your <span class="ncbi_env">PATH</span>.
As an argument to the batch file you can specify either <span class="ncbi_script_a">ALL</span> (or no arguments at all),
or any combination of <span class="ncbi_config">Debug</span>, <span class="ncbi_config">DebugMT</span>, <span class="ncbi_config">DebugDLL</span>, <span class="ncbi_config">Release</span>, <span class="ncbi_config">ReleaseMT</span>,
<span class="ncbi_config">ReleaseDLL</span> to build either all available, or particular configuration(s) respectively.
You can always use MSVC++ Developer Studio (just load workspace file <span class="ncbi_file">ncbi_cpp.dsw</span>)
to build the Toolkit in the interactive manner.

<h4>Transition to single-configuration project files</h4>
This step applies only once, when all current project files are converted to single-configuration
ones, which later can be automatically expanded back to multi-configuration project files,
as required for (production and/or regular) builds.
<ol>
<li>
Check out the MSVC++ project files and tool scripts from <span class="ncbi_dir">internal/c++/compilers/msvc_prj</span>
directory:
<pre class="ncbi_cmd">
$ mkdir ~/msvc_prj; cd ~/msvc_prj
$ cvs co -d . internal/c++/compilers/msvc_prj
</pre></li>

<li>
Apply the following command to convert multi-configuration
project files to single-configuration project files:
<pre class="ncbi_cmd">
$ find . -name "*.dsp" -print -exec ./all2one.sh {} \;
</pre>
For each project file choose the configuration (among available),
which was tested, and known to work. Note that many project
files were created automatically by MSVC++, and contain 2 or more configurations,
but in most cases only one (notably: <span class="ncbi_config">Debug</span>) was customized to work and
to build this particular project, the others are just dummies.<p></li>

<li>
Be sure that the process completed successfully and then delete backup copies:
<pre class="ncbi_cmd">
$ find . -name "*.dsp.bak" -exec rm -f {} \;
</pre></li>

<li>
You may wish to use the script <a href="#one2one_sh"><span class="ncbi_script">one2one.sh</span></a>
for converting all project files to standard single configuration <span class="ncbi_config">DebugDLL</span>, if configurations,
different from <span class="ncbi_config">DebugMT</span>, have been chosen in step 2 above:
<pre class="ncbi_cmd">
$ find . -name "*.dsp" -print -exec ./one2one.sh {} DebugMT \;
</pre></li>

<li>
Check out <span class="ncbi_dir">CVSROOT</span>
directory (this is an administrative directory used to control the entire
CVS tree):
<pre class="ncbi_cmd">
$ mkdir ~/myCVSROOT; cd ~/myCVSROOT
$ cvs co CVSROOT
</pre></li>

<li>
Chdir to the checked out copy of <span class="ncbi_dir">CVSROOT</span>:
<pre class="ncbi_cmd">
$ cd CVSROOT
</pre></li>

<li>
Install (by copying and giving execution permissions)
the following scripts in <span class="ncbi_dir">CVSROOT</span> directory:

<pre class="ncbi_cmd">
$ ( cd internal/c++/compilers/msvc_prj; cp commit.sh all2one.sh ~/myCVSROOT )
$ chmod a+x commit.sh all2one.sh
$ cat >> checkoutlist
  commit.sh
  all2one.sh
&lt;press Ctrl-D>
$ cat >> commitinfo
$ CVSROOT/CVSROOT/commit.sh
&lt;press Ctrl-D>
</pre></li>

<li>
Make sure that the files <span class="ncbi_file">checkoutlist</span>
and <span class="ncbi_file">commitinfo</span>
contain only one entry per each shell script, delete any other entries
if they exist.<p></li>

<li>
Edit script <a href="#commit_sh"><span class="ncbi_script">commit.sh</span></a>
so that the line starting from <span class="ncbi_value">DIRLIST=</span>
would contain a list of directories, delimited by spaces, relative to CVS
tree origin, and which must be checked against for having single-configuration
project files only.<p></li>

<li>
Now check in the changes made in <span class="ncbi_dir">CVSROOT</span>
directory back to the CVS repository:

<pre class="ncbi_cmd">
$ cvs add commit.sh all2one.sh
$ cvs commit -m "MSVC++ Project File Control Added"
</pre>

You should see message, saying that the CVS administrative
directory is being rebuilt. Erase local copy of <span class="ncbi_dir">CVSROOT</span>
directory.<p></li>

<li>
Now chdir back to checked out copy of directory <span class="ncbi_dir">internal/c++/compilers/msvc_prj</span>,
which now should contain single-configuration projects only. You can commit
the projects back to the CVS. This is a bit tricky, as formerly the project
files were kept in binary form, and now they have to be stored in a native text file format.
The easiest way of workaround is to do the following:

<pre class="ncbi_cmd">
$ ( cd $CVSROOT/internal/c++/compilers; mv msvc_prj msvc_prj.old )
$ find . -name CVS -exec rm -rf {} \;
$ cvs import -m "New projects" internal/c++/compilers/msvc_prj NCBI Exp
</pre></li>

<li>
Erase the local copy of project file directory. If
you wish to work further with projects, you should re-check them out again
to ensure that everything is connected back to the repository in a right
way.</li>
</ol>

<!--#include virtual="./ssi/navlinks.shtml" -->

<table border=0 width="100%" cellspacing=0>
<tr>
<td align=left>
  <address><a href="mailto:cpp-core@ncbi.nlm.nih.gov">Anton Lavrentiev</a></address>
</td>
<!-- <td align=center><span class="ncbi_cvs_rev">$Revision$</span></td> -->
<td align=right><span class="ncbi_cvs_date">$Date$</span></td>
</tr>
</table>

<!--#include virtual="./ssi/footer.shtml" -->
