<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
  <title> Processing ASN.1 Data. </title>
</head>
<body BGCOLOR="white">

<h1> Processing ASN.1 Data </h1>

Although this discussion refers specifically to ASN.1 formated data, the data
structures and tools described here have been designed to (potentially) support
any formalized specification, including for example, XML. Many of the tools 
and objects have open-ended abstract or template implementations that can be 
instantiated differently to fit various specifications. This discussion however,
will only refer to ASN.1 data. <p>

<ul>
  <li> <a href="#headersandlibs"> Using the ASN Header Files and Serialization Libraries </a>
  <li> <a href="#example1"> Reading and Writing ASN.1 Data: An Example Application </a>
  <li> <a href="#includes"> Determining Which Header Files to Include</a>
  <li> <a href="#linklibs"> Determining Which Libraries to Link To</a>
  <li> <a href="#general"> Generalizing the Input/Output Formats </a>
  <li> <a href="traverse.html"> Traversing an ASN.1 Data Structure. </a>
</ul>

<a name="headersandlibs">
<h3> Using the ASN Header Files and Serialization Libraries </h3> 

Reading and writing ASN.1 data is implemented by an integrated set of streams, filters,
and ASN.1 object types. Writing an application to read, write or otherwise interpret ASN.1
data will require <i>#include</i> statements in your source files as well as specific library
names to link to in your makefiles.  The ASN.1 object header and implementation files are
located in the 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/objects/">
<i>include/objects</i></a> and 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/src/objects/">
<i>src/objects</i></a> subtrees of the C++ tree,
respectively. The header and implementation files for serialized streams and type
information are in the 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/serial/">
<i>include/serial</i></a> and 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/src/serial/">
<i>src/serial</i></a> directories.

<p>

If you have checked out the <i> objects</i> directories, but not explicitly run the 
<a href="http://sunweb.ncbi.nlm.nih.gov:6224/IEB/corelib/cpp/tools/datatool/datatool.html">
<i>datatool</i></a> code generator, then you will find that your <i>include/objects</i>
subdirectories are (almost) empty, and the source subdirectories contain only ASN.1 specifications.
However, building your own local copies of these header and implementation files is
neither necessary nor recommended, as it is simpler to use the pre-generated header files and
prebuilt libraries. <p>

The pre-built header and implementation files can be found in <i>
$NCBI/c++/include/objects/</i> and <i> $NCBI/c++/src/objects/</i>, respectively.
Assuming your makefile defines an include path to <i>$NCBI/c++/include</i>, selected ASN.1
header files such as 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/objects/general/Date.hpp">
<i> Date.hpp</i></a>, can be included as:
<center>
<xmp>
#include <objects/general/Date.hpp>
</xmp>
</center>

This header file (along with its implementations in the accompanying <i>src</i> directory) was
generated by <a href="http://sunweb.ncbi.nlm.nih.gov:6224/IEB/corelib/cpp/tools/datatool/datatool.html">
<i> datatool</i></a> using the specifications from 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/src/objects/general/general.asn">
<i>src/objects/general/general.asn</i></a>. 

<a name="example1">
<h3> Reading and Writing ASN.1 Data </h3>

Let's consider a program <a href="asntrans_cpp.html"> <i>asntrans.cpp</i></a> that translates an
ASN.1 data file containing an object of type 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/src/objects/mmdb1/mmdb1.asn">
<i>Biostruc</i></a> from binary to text format.  In <i>main()</i>, we begin by
initializing the diagnostic stream to write errors to a local file called <i>
asntrans.log</i>. First, the file is opened with the definition of <i> diag</i> as an
instance of <i> CNcbiOfstream</i>. The subsequent call to <a href="diag.html#setStream">
<i>SetDiagStream()</i> </a> then establishes this stream as the one to log messages to.
Exception handling, program tracing, and error logging are described in the
<a href="diag.html">
Diagnostic Streams </a> section.<p>

An instance of the <i>CTestAsn</i> class is then created, and its (inherited) member 
function <i>AppMain()</i> is invoked. This function in turn calls <i>CTestAsn::Run()</i>.
The first two blocks of code there define the binary input and text output streams.
The two streams are referenced in the program via <a href="cref.html"> <i>auto_ptr</i></a>s, to
ensure automatic destruction of these objects when the function returns or an exception occurs.<p>

The streams now need to have <i> CObject[I/O]Stream</i>s associated with them in order to provide
the proper data serialization mechanisms.
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CObjectIStream.html">
<i> CObjectIStream</i></a> and 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CObjectOStream.html">
<i> CObjectOStream</i></a> are base classes which provide generic interfaces between the
object-specific type information associated with a serializable object's class and an I/O stream. The object
stream classes used in this application,
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CObjectIStreamAsnBinary.html">
(<i>CObjectIStreamAsnBinary</i></a> and
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CObjectOStreamAsn.html">
<i>CObjectOStreamAsn</i></a>)
are descendants of these base classes with specialized serialization methods for ASN.1 binary 
input and ASN.1 text output.
<p>

Finally, a variable for the object type that will be generated from the input stream (in this
case a <a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CBiostruc.html">
<i> CBiostruc</i></a>) is defined, and the <i>CObject[I/O]Stream</i> operators "<<" and
">>" are used to read and write the serialized data to and from the object. (Note that it is
<i> not </i> possible to simply "pass the data through", from the input stream to the output
stream, using a construct like:<i> *inObject >> *outObject</i>). The <i>CObject[I/O]Stream</i>s
know nothing about the structure of the specific object - they have knowledge only of the
serialization format (text ASN, binary ASN, XML, etc.). In contrast, the 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CBiostruc.html">
<i>CBiostruc</i></a> knows
nothing about I/O and serialization formats, but it contains explicit type information about
itself.  Thus, the <i>CObject[I/O]Stream</i>s can apply their specialized serialization methods to
the data members of 
<i>CBiostruc</i> using the type information associated with that object's
class.

<a name="includes">
<h3>Determining Which Header Files to Include </h3>

As always, you will need to include your own local header file defining the current
application class. In this example, <a href="asntrans_hpp.html"> <i>asntrans.hpp</i></a> defines the
<i>CTestAsn</i> class (and in turn, includes the necessary <i>corelib</i> header file for
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CNcbiApplication.html">
<i> CNcbiApplication</i>)</a>.<p>

Determining what additional header files should be included is fairly straightforward: look
at the objects defined in your source code and locate the files which define these
classes or specify type definitions for these names. In this case, the objects include:
<ol>
<li> <i>CNcbiIfstream</i>
<li> <i>CNcbiIstream </i>
<li> <i>CNcbiOfstream</i>
<li> <i>CNcbiOstream</i>
<li> <i>CObjectIStream</i>
<li> <i>CObjectOStream </i>
<li> <i>CObjectIStreamAsnBinary</i>
<li> <i>CObjectOStreamAsn</i>
<li> <i>CBiostruc</i>
</ol>

Since the first four of these are standard C++ streams independent of data format, a likely
place to find their definitions is in the 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/corelib/">
<i>corelib</i></a> directory. Looking at 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/corelib/ncbistre.hpp"><i>
ncbistre.hpp</i></a>, we see that all of these are typedefs in that file. As it turns out however,
this header file is already included indirectly, by a chain of <i>#include</i>s, starting
with the <a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/corelib/ncbistd.hpp">
<i>ncbistd.hpp</i></a> header file. In general, all of your applications should
begin by including this file. (See also the section on
<a href="http://sunweb.ncbi.nlm.nih.gov:6224/IEB/corelib/cpp/new_mod.html"> 
<i>Starting a new C++ module</i></a> in the
Reference Manual.)

<p>

The next four items refer to <i>CObject[I/O]Stream</i> classes - two of which specialize for ASN
formatted data, so a likely place to search for these is in the 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/serial/">
<i>serial</i></a> directory. Lacking any clues for where to look however, the <a
href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/ident">
<i>identifier search</i></a> tool in the source code
navigator should allow you to find whatever class you are looking for.<p>

In the <a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/serial/">
<i>serial</i></a> directory, we find three files that must be included: 

<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/serial/objistrasnb.hpp">
<i>objistrasnb.hpp</i></a>,
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/serial/objostrasn.hpp">
<i>objostrasn.hpp</i></a>, and
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/serial/serial.hpp">
<i> serial.hpp</i></a>. 

The names of the first two files are self-documenting: the first defines objects associated
with input streams containing binary ASN data; the second defines objects associated with
output streams containing ASN text. The last file, 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/serial/serial.hpp">
<i>serial.hpp</i></a>, defines the input and output operators on the generic object serialization streams 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CObjectIStream.html">
<i>CObjectIStream</i></a> and 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CObjectOStream.html">
<i>CObjectOStream</i></a> respectively.<p>

Finally, we must include headers for the ASN type we are using. The easiest way to locate
appropriate header files is to use the source code navigator's
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/ident">
identifier search</a> tool. Alternatively, you can browse the 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/objects">
<i>include/objects</i></a> directories.
For example, the <i>CBiostruc</i> class is defined in 

<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/include/objects/mmdb1/Biostruc.hpp">
<i> include/objects/mmdb1/Biostruc.hpp</i></a>. In summary, the
following <i>#include</i> statements appear at the top of <a href="asntrans_cpp.html"><i>asntrans.cpp</i></a>:

<xmp>
#include <corelib/ncbistd.hpp>
#include <serial/serial.hpp>          
#include <serial/objistrasnb.hpp>     
#include <serial/objostrasn.hpp>
#include <objects/mmdb1/Biostruc.hpp>
#include "asntrans.hpp" 
</xmp>

<a name="linklibs">
<h3>Determining Which Libraries to Link To </h3>
Determining which libraries must be linked to requires a bit more work and may involve
some trial and error. The list of available libraries currently includes:
<pre>
access	 medlars  ncbimime  seq	      seqloc  xconnect
biblio	 medline  objprt    seqalign  seqres  xfcgi
cdd	 mmdb1	  proj	    seqblock  seqset  xhtml
featdef	 mmdb2	  pub	    seqcode   submit  xncbi
general	 mmdb3    pubmed    seqfeat   xcgi    xser
</pre>

It should be clear that we will need to link to the core library, 
<a href="http://sunweb.ncbi.nlm.nih.gov:6224/IEB/corelib/cpp/libs.html#ref_TableXNCBI"><i>xncbi</i></a>, as
well as the serial library, 
<a href="http://sunweb.ncbi.nlm.nih.gov:6224/IEB/corelib/cpp/libs.html#ref_TableXSERIAL">
<i>xser</i></a>. In addition we will need to link to whatever object libraries are
entailed by using a 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CBiostruc.html">
<i>CBiostruc.</i></a> object. Minimally, one would
expect to link to the <i>mmdb</i> libraries. This in itself is insufficient however,
as the <i>CBiostruc</i> class embeds other types of objects, including PubMed citations,
features, and sequences, which in turn embed additional objects such as 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/doc++/CDate.html">
<i>Date</i></a>.
The makefile for <i>asntrans.cpp</i>, <a href="make_asntrans.html"> <i>Makefile.asntrans.app</i></a> lists 
the libraries required for linking in the make variable <i>LIB</i>.
<p>

<a name="general"> 
<h3> Generalizing the Input/Output Formats </h3>

The previous application can easily be generalized to allow binary or text input as well
as output. <a href="asn2asn_cpp.html"> <i> asn2asn.cpp</i></a> works on <i> Seq-entry</i> and
<i> Bioseq-set</i> types (defined in 
<a href="http://ray.nlm.nih.gov:6224/intranet/ieb/CPP/lxr/http/source/src/objects/seqset/seqset.asn">
<i>seqset.asn</i></a>).  Because we now support binary/text input and output, the number
of header files has increased to support the additional stream types entailed.
Comparing the two <a href="make_asn2asn.html"> <i>Makefiles</i></a>, we see that the differences
between them is in the object libraries linked to, as each specializes for different ASN.1
types.
<br>
<br>
<p>
</body>
<a href="webpgs.html"> <i> previous</i> </a>
&nbsp;&nbsp;&nbsp;
<a href="../index.html"> <i> up </i> </a>
&nbsp;&nbsp;&nbsp;
<a href="traverse.html"> <i> next </i> </a>
</html>


	 <hr>
	 <table border=0 width="100%" cellspacing=0>
		<tr>
		  <td><address><a href="mailto:zimmerma@ncbi.nlm.nih.gov">Diane Zimmerman</a></address></td>
		  <!-- <td align=center><i>$Revision$</i></td> -->
		  <td align=right><i>$Date$</i></td>
	 </table>
