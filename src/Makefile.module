SRCDIR = $(top_srcdir)/src/$(MODULE_PATH)
INCLUDEDIR = $(top_srcdir)/include/$(MODULE_PATH)

ASNFILE = $(MODULE_ASN)
IMPFILES = $(MODULE_IMPORT:=.asn)
FILES = $(MODULE).files
MODULEFILE = $(MODULE).module

all: sources makefiles

sources: $(FILES)

clean_sources:
	-rm $(FILES)

purge_sources:
	-rm $(FILES) *_Base.cpp $(INCLUDEDIR)/*_Base.hpp

.NO_PARALLEL:
$(FILES): $(ASNFILE) $(IMPFILES:%=$(top_srcdir)/src/%)
	$(DATATOOL) -m $(ASNFILE) $(IMPFILES:%=-M %) -oA -of $@ -or $(MODULE_PATH) -oR $(top_srcdir)

makefiles: Makefile.in Makefile.$(MODULE).lib

Makefile.in: $(MODULEFILE)
	@echo Updating $@
	@( \
		echo "LIB_PROJ = $(MODULE)"; \
		echo "srcdir = @srcdir@"; \
		echo "include @builddir@/Makefile.meta"; \
	) > $@

Makefile.$(MODULE).lib: $(MODULEFILE)
	@echo Updating $@
	@( \
		echo 'LIB = $(MODULE)'; \
		echo 'include $$(srcdir)/$(MODULE).files'; \
		echo 'LIBOBJ = $$(GENFILES_LOCAL) $$(GENFILES_LOCAL:=_Base)'; \
	) > $@

$(MODULEFILE):

directories:
	mkdir -p $(top_srcdir)/src/$(MODULE_PATH)
	mkdir -p $(top_srcdir)/include/$(MODULE_PATH)
